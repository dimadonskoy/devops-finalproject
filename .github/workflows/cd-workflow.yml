name: AI local model CD Pipeline

on:
  workflow_dispatch:

jobs:
  Deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    env:
      # Set the working directory for all Terraform commands
      TF_WORKING_DIR: pcloud/terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # Use a service principal with contributor role on the resource group

      - name: Initialize Terraform
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} init

      - name: Plan Terraform changes
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan \
            -var="openai_key=${{ secrets.OPENAI_KEY }}"

      - name: Apply Terraform configuration
        id: terraform_apply
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} apply \
            -var="openai_key=${{ secrets.OPENAI_KEY }}" \
            -auto-approve

      - name: Get VM IP Address
        id: get_ip
        run: |
          VM_IP=$(terraform -chdir=${{ env.TF_WORKING_DIR }} output -raw vm_public_ip)
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "The VM has been provisioned and is being configured via cloud-init." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Public IP:** \`${{ env.VM_IP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Access Web UI:** http://${{ env.VM_IP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SSH Access:** \`ssh openwebui@${{ env.VM_IP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Please allow a few minutes for the \`deploy-on-cloud.sh\` script to complete the application setup on the VM." >> $GITHUB_STEP_SUMMARY
